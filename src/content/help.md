# iFigmaLab 사용 가이드

iFigmaLab은 Figma 디자인을 Google Gemini AI로 분석하여 즉시 실행 가능한 HTML, CSS, JS 코드로 변환해 주는 도구입니다.

---

## 🚀 빠른 시작

### 1단계: API 키 설정 (AGENT 탭)

- 사용할 **Gemini API 키**를 입력합니다.
- **로컬 암호화 저장**을 체크한 뒤 **4자리 이상의 PIN**을 입력하면, 사용 중인 브라우저의 로컬 저장소에 API 키가 안전하게 암호화되어 보관됩니다. 재방문 시에는 PIN만 입력하여 간편하게 잠금을 해제(Unlock)할 수 있습니다.
- API 키가 없다면 **GET** 링크를 클릭하여 [Google AI Studio](https://aistudio.google.com/apikey)에서 무료로 발급받을 수 있습니다.

### 2단계: AI 모델 선택 (AGENT 탭)

- 드롭다운 목록에서 원하는 AI 모델을 선택한 후 **SET** 버튼을 클릭하여 적용합니다.
- 모델 선택과 실제 적용은 별개로 이루어집니다. 따라서 최종 적용을 위해서는 반드시 **SET** 버튼을 클릭해야 합니다.
- **↻ 새로고침** 버튼을 클릭하면 Gemini API와 통신하여 최신 지원 모델 목록을 불러옵니다. (단, API 키가 입력되어 있어야 합니다.)

### 3단계: 디자인 데이터 가져오기 (MCP 탭)

Figma 데이터는 자동 연동 또는 직접 붙여넣기 방식으로 가져올 수 있습니다.

**방법 A: Figma 자동 연동**
1. Figma 데스크톱 앱을 실행합니다.
2. 로컬 Proxy 서버(`localhost:3006`)를 실행합니다.
3. 화면상 연결 상태가 `Connected`인지 확인합니다.
4. 변환할 디자인의 Figma Node ID 또는 전체 URL을 입력한 후 **Fetch** 버튼을 클릭합니다.

**방법 B: 직접 붙여넣기 (Proxy 서버 미사용 시)**
- Proxy 서버 연동 없이 사용하려면, Figma에서 직접 복사한 디자인 컨텍스트(JSON 포맷)를 Context 입력창에 붙여넣습니다.

### 4단계: 코드 생성 (MCP 탭)

- **Prompt**: AI가 코드를 작성할 때 참고할 추가 지시사항을 자유롭게 입력합니다. (생략 가능)
- **Count Tokens**: **Submit** 전에 전송될 전체 토큰 수를 미리 가늠해볼 수 있습니다.
- **Submit ▶**: 변환 요청을 시작합니다.
- 변환이 완료되면 패널 하단의 인라인 창에서 결과를 미리 볼 수 있으며, 우측 하단 알림을 통해 VIEW 탭으로 즉시 이동하여 전체 화면으로 결과를 확인할 수 있습니다.

---

## 📑 탭 안내

- **AGENT**: Gemini API 키 입력, 사용할 AI 모델 선택 및 로컬 암호화 저장 설정을 관리합니다.
- **MCP**: Figma 연동, 디자인 컨텍스트 입력, 코드 생성 요청 및 생성 결과의 인라인 프리뷰를 제공합니다.
- **VIEW**: AI가 생성한 HTML 코드를 전체 화면 크기의 샌드박스로 렌더링하여 보여줍니다.
- **HELP**: 현재 보고 계신 사용 가이드 페이지입니다.

---

## ⚙️ AGENT 탭 상세 기능

### AI 공급자 지원
현재 **Google Gemini** 모델을 기본 지원하고 있으며, 추후 Claude 및 Codex 등 다양한 AI 모델이 추가될 예정입니다.

### API 키 관리

- **입력창**: 보안을 위해 기본적으로 키워드가 숨김 처리되며, Show/Hide 버튼을 통해 값을 확인할 수 있습니다.
- **로컬 암호화 저장**: 체크 시 설정한 PIN 번호(4자리 이상)를 이용해 API 키를 AES 방식으로 암호화하여 브라우저 `localStorage`에 보관합니다.
- **잠금 해제 / Clear**: 이전에 암호화 저장된 키가 감지되면 잠금 화면이 나타납니다. PIN을 입력해 잠금을 풀(Unlock) 수 있으며, Clear 버튼으로 저장된 데이터를 모두 지울 수 있습니다.

### 모델 설정

- **드롭다운**: 선택 형태의 사용 가능한 AI 모델 목록입니다. (기본값: `gemini-2.5-flash`)
- **↻ 새로고침**: 실시간으로 Gemini API를 호출해 현재 사용 가능한 모델(`generateContent` 메서드 지원)을 동적으로 갱신합니다.
- **SET**: 드롭다운에서 고른 모델을 실제로 프로젝트에 적용합니다. 적용되지 않은 모델을 선택 중일 땐 버튼이 파란색으로 활성화됩니다.
- **현재 적용**: UI 하단에 SET 버튼으로 최종 반영된 모델의 이름이 명시됩니다.

### 정보 제공 (Get Model Info)
API 키와 모델을 올바르게 설정한 상태에서 **Get Model Info** 버튼을 누르면 해당 모델의 상세한 스펙(`버전`, `입/출력 토큰 제한`, `메서드 지원 여부`, `Temperature` 등)을 JSON 형태로 조회하여 표시해 줍니다.

---

## 📐 MCP 탭 상세 기능

### 통신 및 Figma 연동 (Figma MCP 연동 패널)

- **Server URL**: Figma 데스크톱 앱 내의 MCP 서버 주소입니다. (기본값: `http://localhost:3845`)
- **Apply**: 입력된 커스텀 URL로 접속이 가능한지 재확인합니다.
- **연결 상태**: 10초 주기로 서버 폴링을 진행하며 `Connected`(초록색) 혹은 `Disconnected`(회색)로 표시됩니다.
- **Node ID**: 대상 Node ID 값(예: `12-34`)이나 전체 URL(하이픈 또는 콜론 형식 모두 자동 파싱)을 입력합니다.
- **Fetch**: Proxy 서버와 통신하여 디자인 객체 정보들을 가져온 뒤 하단의 Context 박스에 결과값을 채워 넣습니다.
- **Screenshot**: Node ID 기반으로 대상 화면을 스크린샷으로 곧바로 캡처하여 AI의 시각적 판단 도구로 첨부합니다. (Figma 연동이 완료된 상태여야 합니다)
- **이미지 미리보기**: 버튼 실행 후 캡처된 섬네일을 표시하며, **✕ 제거** 기능으로 모델에 불필요한 이미지 정보가 전송되는 것을 막을 수 있습니다.

### 변환 요청 (Design Prompt 패널)

- **Context**: Figma 디자인 정보(JSON 형식)입니다. Fetch 결과값이 자동 삽입되거나 원본을 직접 붙여넣을 수 있습니다.
- **크기 뱃지**: 입력된 컨텍스트의 바이트(Byte/KB) 단위 크기를 실시간으로 계산해 줍니다.
- **Optimize**: 불필요한 Figma 내부 `data-*` 속성을 일괄 정리하여 전송할 텍스트 파일 크기를 가볍게 최적화합니다. (토큰 절약)
- **Prompt**: AI 생성 시 활용할 추가 요구사항(스타일, 기능 제약 등)을 담습니다. 미입력 시 iFigmaLab의 기본 프롬프트가 동작합니다.
- **준비 상태 뱃지**: API 키 입력 여부와 생성할 데이터 존재 여부를 `✓` 및 `✗` 심볼로 한눈에 표기합니다.
- **Count Tokens**: **Submit** 요청 전에 현재 입력된 데이터들을 바탕으로 예상 소비 토큰 값을 화면에 미리 보여줍니다.

### 결과 확인 및 디버깅

- **미리보기 / 기능**: 제출 완료 후 결과물에 대해 HTML 소스 코드(Show Code), 렌더링된 인라인 뷰, 텍스트 다운로드 도구(`Download HTML`), 원본 API 응답 파싱 체크 도구(`Debug Info`)를 통합적으로 제공합니다.
- **Debug Log**: 작동 과정(입력값 검증, 네트워크 지연, HTML 태그 무결성 판단 등)을 상세하게 기록하는 시스템 로그입니다. 메모리 누수를 방지하기 위해 최근 500줄까지만 표시되며, 사용자 임의의 **Clear** 동작도 지원합니다.

---

## 🖥 VIEW 탭 가이드

- AI 모델이 작성해 낸 최종 결과물(HTML 문서)을 안전하게 격리된 `<iframe>` 샌드박스 내부에서 렌더링합니다.
- 변환 처리가 완료될 시 우측 하단에 완료 알림 팝업이 띄워지며, **VIEW로 이동** 버튼을 누르면 즉시 전체 화면 미리보기 창으로 이동합니다. 알림 팝업은 5초 뒤에 자동으로 닫힙니다.

---

## 🤖 현재 지원 시스템 모델

- **`gemini-2.5-pro`**: **최고 성능** — 복잡한 레이아웃 분석과 다양한 맥락들을 필요로 하는 화면 구조 분해에 가장 적합한 고성능 모델입니다.
- **`gemini-2.5-flash`**: **기본값** — 매우 뛰어난 속도, 준수한 품질을 지닌 다용도 모델로 실무적인 변환 속도와 비용 효율에 강점을 보입니다.
- **`gemini-2.5-flash-lite`**: **경량화** — 단순 생성 작업에 투입할 수 있는 가장 가볍고 지연 시간이 짧은 모델입니다.
- **`gemini-2.0-flash`**: 이전 세대의 안정성을 지닌 플래시 모델입니다.

> **팁:** `AGENT` 탭 내의 **↻ 새로고침** 버튼을 활용하면 Google API를 통해 새롭게 출시되는 신규 버전의 모델명들도 즉시 동기화해 사용할 수 있습니다.

---

## 🏗 시스템 아키텍처

```text
Figma Desktop App
  └─ Figma MCP Server  (:3845)
       └─ Proxy Server  (:3006)
            └─ iFigmaLab  (:3005, 브라우저 환경)
                 └─ Google Gemini API (v1beta)
```

- **Gemini API 직접 호출:** 텍스트, 이미지 전송 및 코드 변환 등의 AI 요청은 서버 의존성을 최소화하고 속도를 높이기 위하여 백엔드를 경유하지 않고 브라우저에서 직접 수행됩니다.
- **Proxy 역할 제한:** Proxy 서버는 오로지 웹 브라우저가 도달할 수 없는 로컬 `Figma MCP Server`와 통신하여 데이터를 간접적으로 읽어오거나 캡처(Screenshot)를 수행하는 도우미 역할만을 담당합니다.

---

## ⚠️ 문제 해결 및 자주 묻는 질문(FAQ)

**Q. "API Key가 유효하지 않습니다" 혹은 오류 메시지가 뜹니다.**
- `AGENT` 탭 → **Get Model Info** 기능을 이용해 입력하신 API 키의 유효 여부를 먼저 확인하세요.
- 복사/붙여넣기 과정에서 키워드의 앞뒤로 보이지 않는 공백 문자가 포함되진 않았는지 점검해 보시기 바랍니다.

**Q. 버튼이 `Disconnected` 상태로, Proxy 서버 연결이 안 됩니다.**
- 실제 데스크톱의 Figma 프로그램 내에 프로젝트 파일이 제대로 띄워져 있는지 살펴봐야 합니다.
- 터미널 등을 통해 Proxy Server(`localhost:3006`)가 정상적으로 동작 중인지 프로세스 상태를 함께 점검해 주세요.
- 만일 로컬 환경 구성이 제한될 경우, MCP 연동 기반 대신 플러그인을 거친 Design Context 텍스트 데이터를 직접 입력창에 붙여넣어 사용하는 우회적인 사용법도 존재합니다.

**Q. Screenshot 캡처 버튼을 누를 수가 없습니다.**
- 캡처 동작은 Proxy Server와의 연동(`Connected`)과 캡처할 대상의 타겟 포인트(`Node ID` 입력 유무)가 모두 만족되어야만 활성화됩니다.

**Q. 사용할 모델 리스트에서 옵션을 바꿨는데 기존 모델이 동작합니다.**
- 메뉴의 드롭다운 리스트 변경 후, 반드시 우측에 파란색으로 변하는 **SET** 버튼을 클릭하여야 시스템 변수에 선택한 모델이 완전히 반영됩니다.

**Q. 생성된 HTML 코드가 중간에 뚝 끊기거나 미완성 상태입니다.**
- LLM 모델 당 한 번에 처리하고 출력할 수 있는 토큰의 한계치를 넘을 때 발생합니다. `Debug Log` 화면을 살펴보셔서 끝맺음 오류인 `MAX_TOKENS` 중단 에러가 남았는지 확인하세요.
- 해결방안: 입력 데이터를 최적화시킬 수 있는 **Optimize** 기능을 통해 Figma Attribute들을 정리하거나 `gemini-2.5-pro`와 같은 최대 출력 토큰 제약 범위가 월등히 높은 상위 등급의 모델을 사용해 볼 것을 권장합니다.
- 복잡한 대형 컴포넌트나 아주 길게 디자인된 화면들은 캡처 범위를 요소별로 세부적으로 나누어 여러 차례로 코드 분석을 요청하는 것도 매우 효과적인 방법입니다.
